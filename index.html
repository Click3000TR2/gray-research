<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ricerca Percezione Colore</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        #container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .box {
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 500px;
            width: 100%;
        }

        h1 { font-size: 22px; color: #333; margin-bottom: 20px; }
        p { color: #555; line-height: 1.6; }

        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s;
            font-weight: bold;
        }
        button:active { transform: scale(0.95); }

        .btn-primary { background-color: #333; color: white; }
        .btn-secondary { background-color: #e0e0e0; color: #333; }

        /* Stile specifico per Si/No */
        #btn-yes { background-color: #e0e0e0; color: #333; } /* Si è grigio */
        #btn-no { background-color: #333; color: white; } /* No (è colore) */

        ul { text-align: left; margin-bottom: 30px; }
        
        /* Spinner caricamento */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="container">
        
        <div class="box" id="welcome">
            <h1>Benvenuto/a</h1>
            <p>Stai per partecipare a un breve test sulla percezione del colore.</p>
            <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeeba; margin: 20px 0;">
                <strong>⚠️ Prima di iniziare:</strong>
                <ul style="margin-bottom:0; margin-top:10px;">
                    <li>Imposta la luminosità dello schermo al <strong>massimo</strong>.</li>
                    <li>Disattiva modalità "notte", "protezione occhi" o "filtri luce blu".</li>
                    <li>Pulisci lo schermo se necessario.</li>
                </ul>
            </div>
            <p>Il test dura circa 1 minuto. I dati sono anonimi.</p>
            <button class="btn-primary" onclick="iniziaTest()" style="width:100%">Ho capito, Inizia</button>
        </div>

        <div class="box" id="interface" style="display:none;">
            <h1>Chiameresti questo colore "GRIGIO"?</h1>
            
            <div class="btn-container">
                <button id="btn-yes" onclick="rispostaUtente(true)">SÌ</button>
                <button id="btn-no" onclick="rispostaUtente(false)">NO</button>
            </div>
            <p id="progress" style="margin-top:20px; color:#888; font-size: 12px;">Caricamento...</p>
        </div>

        <div class="box" id="results" style="display:none;">
            <h2>Grazie!</h2>
            <p id="msg-salvataggio">Salvataggio dati in corso...</p>
            <div class="loader" id="loader"></div>
            <p id="msg-finale" style="display:none; color: green; font-weight: bold;">Dati salvati con successo!</p>
            <button onclick="location.reload()" style="margin-top: 20px; background-color: #666; color: white;">Rifai il test</button>
        </div>
    </div>

    <script>
        // *** IMPORTANTE: INCOLLERAI QUI L'URL DEL TUO SCRIPT TRA POCO ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzrtT_KuQLzGBACPSmoPrVqDDekYtoEr6bWsnrRu6pOfP_bFFf6ukX1NAfqphaucm3Ag/exec"; 
        // Lascialo vuoto per ora, lo riempiremo alla fine.

        const tuttiIColori = [];
        // Generiamo 24 tinte
        for (let i = 0; i < 24; i++) {
            tuttiIColori.push({ hue: i * 15, id: i });
        }

        let coloriTest = [];
        let indiceColoreCorrente = 0;
        let rangeMin = 0;
        let rangeMax = 100;
        let saturazioneAttuale = 100;
        let risultati = [];
        let sessionID = Date.now().toString(36) + Math.random().toString(36).substr(2); // ID anonimo per raggruppare le risposte

        function prendiColoriStratificati() {
            // Dividiamo i 24 colori in 6 settori da 4 colori ciascuno
            // Settore 0: 0-3 (Rossi/Aranci), Settore 1: 4-7 (Gialli/Verdi), etc.
            let selezione = [];
            let settori = 6;
            let coloriPerSettore = 4;
            
            for (let s = 0; s < settori; s++) {
                let offset = s * coloriPerSettore;
                // Prende un numero random da 0 a 3 e lo somma all'offset
                let randomIndex = Math.floor(Math.random() * coloriPerSettore);
                selezione.push(tuttiIColori[offset + randomIndex]);
            }
            // Mischiamo l'ordine dei settori affinché non siano sempre in sequenza arcobaleno
            return selezione.sort(() => 0.5 - Math.random());
        }

        function iniziaTest() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('interface').style.display = 'block';
            coloriTest = prendiColoriStratificati();
            indiceColoreCorrente = 0;
            setupNuovoColore();
        }

        function setupNuovoColore() {
            if (indiceColoreCorrente >= coloriTest.length) {
                inviaDati();
                return;
            }
            rangeMin = 0;
            rangeMax = 100;
            saturazioneAttuale = 100; 
            aggiornaSchermo();
        }

        function aggiornaSchermo() {
            let hue = coloriTest[indiceColoreCorrente].hue;
            document.body.style.backgroundColor = `hsl(${hue}, ${saturazioneAttuale}%, 50%)`;
            document.getElementById('progress').innerText = `Campione ${indiceColoreCorrente + 1} di ${coloriTest.length}`;
        }

        function rispostaUtente(isGrey) {
            // isGrey = TRUE -> L'utente ha premuto "Sì" (vede grigio) -> Dobbiamo aumentare saturazione
            // isGrey = FALSE -> L'utente ha premuto "No" (vede colore) -> Dobbiamo diminuire saturazione

            if (isGrey) {
                // Vede grigio: il colore è troppo desaturato.
                // La soglia del colore è PIÙ ALTA di quella attuale.
                rangeMin = saturazioneAttuale;
            } else {
                // Vede colore: siamo sopra la soglia.
                rangeMax = saturazioneAttuale;
            }

            if ((rangeMax - rangeMin) <= 5) {
                let sogliaFinale = Math.round((rangeMax + rangeMin) / 2);
                risultati.push({
                    tinta_gradi: coloriTest[indiceColoreCorrente].hue,
                    soglia_perc: sogliaFinale
                });
                indiceColoreCorrente++;
                setupNuovoColore();
            } else {
                let range = rangeMax - rangeMin;
                let randomStep = Math.floor(Math.random() * range);
                saturazioneAttuale = rangeMin + randomStep;
                
                if (saturazioneAttuale === rangeMin) saturazioneAttuale++;
                if (saturazioneAttuale === rangeMax) saturazioneAttuale--;
                
                aggiornaSchermo();
            }
        }

        function inviaDati() {
            document.body.style.backgroundColor = "#f0f0f0";
            document.getElementById('interface').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.getElementById('loader').style.display = 'block';

            if (!GOOGLE_SCRIPT_URL) {
                document.getElementById('msg-salvataggio').innerText = "Modalità test (Nessun database collegato).";
                document.getElementById('loader').style.display = 'none';
                console.log(risultati);
                return;
            }

            // Prepariamo i dati
            const payload = {
                sessione: sessionID,
                data: new Date().toISOString(),
                risultati: risultati
            };

            // Invio a Google Sheets
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Importante per Google Apps Script
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            }).then(response => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('msg-salvataggio').style.display = 'none';
                document.getElementById('msg-finale').style.display = 'block';
            }).catch(error => {
                document.getElementById('msg-salvataggio').innerText = "Errore nel salvataggio.";
            });
        }
    </script>
</body>
</html>