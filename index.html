<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Grey Zone Experiment</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            background-color: #000000; /* Start with Black */
            color: #333; /* Default text color inside boxes */
        }

        #container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            transition: opacity 0.2s;
        }

        .box {
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255,255,255,0.1); /* Lighter shadow for dark bg */
            max-width: 500px;
            width: 100%;
        }

        h1 { font-size: 24px; color: #333; margin-bottom: 20px; }
        p { color: #555; line-height: 1.6; margin-bottom: 15px; }

        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 20px;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:active { transform: scale(0.96); }

        .btn-primary { background-color: #333; color: white; padding: 15px; }
        
        #btn-grey { 
            background-color: #e0e0e0; 
            color: #333; 
            border: 2px solid #ccc;
        } 
        #btn-color { 
            background-color: #333; 
            color: white; 
            border: 2px solid #333;
        } 

        ul { text-align: left; margin-bottom: 20px; padding-left: 20px; }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #counter {
            position: absolute;
            top: 20px;
            right: 20px;
            color: rgba(255,255,255,0.5); /* Light text for black bg */
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="counter" style="display:none;">0 / 30</div>

    <div id="container">
        
        <div class="box" id="welcome">
            <h1>The "Grey Zone" Experiment</h1>
            <p>Does a color exist if you can't name it? Help us map the boundary between "Color" and "Grey".</p>
            
            <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeeba; margin: 20px 0; font-size: 0.95em; color: #333;">
                <strong>⚠️ Requirements:</strong>
                <ul style="margin-top:10px;">
                    <li>Screen Brightness: <strong>100%</strong></li>
                    <li>Disable "Night Mode" / Blue Light Filters.</li>
                    <li>Clean Screen.</li>
                </ul>
            </div>
            
            <p style="font-size: 0.9em; font-style: italic; color: #666;">
                You will see a series of dark or pale colors. Simply classify them as GREY (neutral) or COLOR (if you see any hint of hue). <br>It takes about 60 seconds.
            </p>

            <button class="btn-primary" onclick="startTest()">Start Experiment</button>
        </div>

        <div class="box" id="interface" style="display:none;">
            <h2 style="margin-bottom: 40px;">Is this Grey?</h2>
            
            <div class="btn-container">
                <button id="btn-grey" onclick="registerResponse('GREY')">Yes, it's Grey</button>
                <button id="btn-color" onclick="registerResponse('COLOR')">No, I see Color</button>
            </div>
        </div>

        <div class="box" id="results" style="display:none;">
            <h2>Test Complete</h2>
            <p>Saving your data...</p>
            <div class="loader" id="loader"></div>
            
            <p id="msg-final" style="display:none; color: green; font-weight: bold;">Done! Thank you.</p>
            <p id="msg-error" style="display:none; color: red;">Error saving data.</p>
            
            <p style="font-size:0.9em; margin-top:20px;">You have contributed to a global map of color perception.</p>
            <button onclick="location.reload()" style="margin-top: 20px; background-color: #666; color: white; padding:10px 20px;">Take it again</button>
        </div>
    </div>

    <script>
        // *** INCOLLA IL TUO SCRIPT QUI ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzrtT_KuQLzGBACPSmoPrVqDDekYtoEr6bWsnrRu6pOfP_bFFf6ukX1NAfqphaucm3Ag/exec"; 

        // CONFIGURAZIONE
        const TOTAL_TRIALS = 30; 
        const SATURATION_LIMIT = 50; // Range 0% - 50%
        
        let trialQueue = [];
        let currentTrialIndex = 0;
        let userResults = [];
        let sessionID = Date.now().toString(36) + Math.random().toString(36).substr(2); 

        // Funzione per catturare il parametro "source" dall'URL (es. ?source=reddit)
        function getSourceParam() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('source') || 'direct'; // Se non c'è, usa 'direct'
        }
        let userSource = getSourceParam();

        function generateTrials() {
            let trials = [];
            // Le 24 tinte fisse (0, 15, 30 ... 345)
            let possibleHues = [];
            for (let i = 0; i < 24; i++) {
                possibleHues.push(i * 15);
            }

            for (let i = 0; i < TOTAL_TRIALS; i++) {
                // Scegliamo una delle 24 tinte a caso
                let hue = possibleHues[Math.floor(Math.random() * possibleHues.length)];
                
                // Saturazione: Completamente random tra 0 e 50%
                // Niente più "catch trials" ad alta saturazione
                let sat = Math.floor(Math.random() * (SATURATION_LIMIT + 1));

                trials.push({ hue: hue, sat: sat });
            }
            return trials;
        }

        function startTest() {
            trialQueue = generateTrials();
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('interface').style.display = 'block';
            document.getElementById('counter').style.display = 'block';
            
            showNextColor();
        }

        function showNextColor() {
            if (currentTrialIndex >= trialQueue.length) {
                sendData();
                return;
            }

            // Update Counter
            document.getElementById('counter').innerText = `${currentTrialIndex + 1} / ${TOTAL_TRIALS}`;

            // INTER-STIMULUS INTERVAL (NERO)
            document.getElementById('interface').style.opacity = '0';
            document.body.style.backgroundColor = 'black'; // PALATE CLEANSER NERO

            // Dopo 400ms mostriamo il colore
            setTimeout(() => {
                let t = trialQueue[currentTrialIndex];
                
                document.body.style.backgroundColor = `hsl(${t.hue}, ${t.sat}%, 50%)`;
                
                document.getElementById('interface').style.opacity = '1';
                
            }, 400); 
        }

        function registerResponse(responseType) {
            let currentTrial = trialQueue[currentTrialIndex];
            
            userResults.push({
                hue: currentTrial.hue,
                sat: currentTrial.sat,
                response: responseType
            });

            currentTrialIndex++;
            showNextColor();
        }

        function sendData() {
            document.getElementById('interface').style.display = 'none';
            document.getElementById('counter').style.display = 'none';
            document.body.style.backgroundColor = "#f0f0f0"; 
            document.getElementById('results').style.display = 'block';
            document.getElementById('loader').style.display = 'block';

            if (!GOOGLE_SCRIPT_URL) {
                document.getElementById('msg-final').innerText = "Test Mode (No Save).";
                document.getElementById('msg-final').style.display = 'block';
                document.getElementById('loader').style.display = 'none';
                console.log(userResults);
                return;
            }

            const payload = {
                session: sessionID,
                timestamp: new Date().toISOString(),
                source: userSource, // Inviamo la fonte al database
                data: userResults
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('msg-final').style.display = 'block';
            }).catch(() => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('msg-error').style.display = 'block';
            });
        }
    </script>
</body>
</html>
