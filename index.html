<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Perception Study</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        #container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .box {
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-width: 500px;
            width: 100%;
        }

        h1 { font-size: 24px; color: #333; margin-bottom: 20px; }
        p { color: #555; line-height: 1.6; margin-bottom: 15px; }

        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.1s;
            font-weight: bold;
        }
        button:active { transform: scale(0.95); }

        .btn-primary { background-color: #333; color: white; }
        
        /* Specific styles for Yes/No */
        #btn-yes { background-color: #e0e0e0; color: #333; } /* Yes, it's grey */
        #btn-no { background-color: #333; color: white; } /* No, I see color */

        ul { text-align: left; margin-bottom: 20px; padding-left: 20px; }
        li { margin-bottom: 5px; color: #444; }
        
        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="container">
        
        <div class="box" id="welcome">
            <h1>Color Perception Study</h1>
            <p>Thank you for participating in this research. The goal is to understand how we perceive color saturation boundaries.</p>
            
            <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeeba; margin: 20px 0; font-size: 0.95em;">
                <strong>⚠️ Before we begin:</strong>
                <ul style="margin-top:10px;">
                    <li>Set your screen brightness to <strong>MAXIMUM</strong>.</li>
                    <li>Disable "Night Shift", "Blue Light Filters", or "Eye Comfort Shield".</li>
                    <li>Ensure your screen is clean.</li>
                </ul>
            </div>
            
            <p style="font-size: 0.9em; font-style: italic; color: #666;">
                Please answer as seriously and accurately as possible. The test adapts to your answers and takes about 60 seconds.
            </p>

            <button class="btn-primary" onclick="startTest()" style="width:100%">I understand, Start</button>
        </div>

        <div class="box" id="interface" style="display:none;">
            <h1>Would you call this color "GREY"?</h1>
            
            <div class="btn-container">
                <button id="btn-yes" onclick="userResponse(true)">YES</button>
                <button id="btn-no" onclick="userResponse(false)">NO</button>
            </div>
            <p id="progress" style="margin-top:20px; color:#888; font-size: 12px;">Loading...</p>
        </div>

        <div class="box" id="results" style="display:none;">
            <h2>Thank You!</h2>
            <p>Your contribution is very valuable.</p>
            
            <p id="msg-saving">Saving data...</p>
            <div class="loader" id="loader"></div>
            
            <p id="msg-final" style="display:none; color: green; font-weight: bold;">Data saved successfully!</p>
            <p id="msg-error" style="display:none; color: red;">Error saving data.</p>
            
            <button onclick="location.reload()" style="margin-top: 20px; background-color: #666; color: white;">Restart Test</button>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwzrtT_KuQLzGBACPSmoPrVqDDekYtoEr6bWsnrRu6pOfP_bFFf6ukX1NAfqphaucm3Ag/exec"; 

        const allColors = [];
        // Generate 24 hues
        for (let i = 0; i < 24; i++) {
            allColors.push({ hue: i * 15, id: i });
        }

        let testColors = [];
        let currentIndex = 0;
        let rangeMin = 0;
        let rangeMax = 100;
        let currentSat = 100;
        let results = [];
        // Anonymous session ID
        let sessionID = Date.now().toString(36) + Math.random().toString(36).substr(2); 

        // Stratified Random Sampling
        function getStratifiedColors() {
            // Divide 24 colors into 6 sectors of 4 colors each
            let selection = [];
            let sectors = 6;
            let colorsPerSector = 4;
            
            for (let s = 0; s < sectors; s++) {
                let offset = s * colorsPerSector;
                let randomIndex = Math.floor(Math.random() * colorsPerSector);
                selection.push(allColors[offset + randomIndex]);
            }
            // Shuffle sector order
            return selection.sort(() => 0.5 - Math.random());
        }

        function startTest() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('interface').style.display = 'block';
            testColors = getStratifiedColors();
            currentIndex = 0;
            setupNewColor();
        }

        function setupNewColor() {
            if (currentIndex >= testColors.length) {
                sendData();
                return;
            }
            // Reset binary search range
            rangeMin = 0;
            rangeMax = 100;
            currentSat = 100; 
            updateScreen();
        }

        function updateScreen() {
            let hue = testColors[currentIndex].hue;
            document.body.style.backgroundColor = `hsl(${hue}, ${currentSat}%, 50%)`;
            document.getElementById('progress').innerText = `Sample ${currentIndex + 1} of ${testColors.length}`;
        }

        function userResponse(isGrey) {
            // Logic:
            // isGrey = TRUE -> User sees Grey. Saturation is too low. Threshold is HIGHER.
            // isGrey = FALSE -> User sees Color. We are above threshold.

            if (isGrey) {
                rangeMin = currentSat;
            } else {
                rangeMax = currentSat;
            }

            // Convergence check (5% tolerance)
            if ((rangeMax - rangeMin) <= 5) {
                let finalThreshold = Math.round((rangeMax + rangeMin) / 2);
                results.push({
                    hue_deg: testColors[currentIndex].hue,
                    threshold_pct: finalThreshold
                });
                currentIndex++;
                setupNewColor();
            } else {
                // Random Step Binary Search
                let range = rangeMax - rangeMin;
                let randomStep = Math.floor(Math.random() * range);
                currentSat = rangeMin + randomStep;
                
                // Ensure we move at least 1% from bounds
                if (currentSat === rangeMin) currentSat++;
                if (currentSat === rangeMax) currentSat--;
                
                updateScreen();
            }
        }

        function sendData() {
            document.body.style.backgroundColor = "#f0f0f0";
            document.getElementById('interface').style.display = 'none';
            document.getElementById('results').style.display = 'block';
            document.getElementById('loader').style.display = 'block';

            if (!GOOGLE_SCRIPT_URL) {
                document.getElementById('msg-saving').innerText = "Test Mode (No Database linked).";
                document.getElementById('loader').style.display = 'none';
                console.log(results);
                return;
            }

            const payload = {
                session: sessionID,
                timestamp: new Date().toISOString(),
                data: results
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            }).then(response => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('msg-saving').style.display = 'none';
                document.getElementById('msg-final').style.display = 'block';
            }).catch(error => {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('msg-saving').style.display = 'none';
                document.getElementById('msg-error').style.display = 'block';
            });
        }
    </script>
</body>
</html>
