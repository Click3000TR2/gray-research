<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grey Zone Study</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow: hidden;
            background-color: #000000;
            color: #333;
        }

        #container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .box {
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(255,255,255,0.1);
            max-width: 500px;
            width: 100%;
            transition: opacity 0.2s;
        }

        h1 { font-size: 22px; color: #333; margin-bottom: 20px; }
        p { color: #555; line-height: 1.6; margin-bottom: 15px; }

        .btn-container {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-top: 30px;
        }

        button {
            flex: 1;
            padding: 25px; /* Pulsanti più grandi */
            font-size: 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button:active { transform: scale(0.96); }

        .btn-primary { background-color: #333; color: white; padding: 15px; font-size: 18px; }
        
        #btn-yes { 
            background-color: #e0e0e0; 
            color: #333; 
            border: 2px solid #ccc;
        } 
        #btn-no { 
            background-color: #333; 
            color: white; 
            border: 2px solid #333;
        } 

        ul { text-align: left; margin-bottom: 20px; padding-left: 20px; }
        
        /* Piccola notifica di salvataggio */
        #save-status {
            position: absolute;
            bottom: 20px;
            color: #666;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.5s;
            background-color: rgba(255,255,255,0.9);
            padding: 5px 10px;
            border-radius: 20px;
        }

        #counter {
            position: absolute;
            top: 20px;
            right: 20px;
            color: rgba(255,255,255,0.5);
            font-size: 14px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="counter" style="display:none;">Count: 0</div>
    
    <div id="save-status">Auto-saving data...</div>

    <div id="container">
        
        <div class="box" id="welcome">
            <h1>Color Perception Study</h1>
            
            <p>The goal of this survey is to determine at what saturation index a color becomes grey.</p>
            
            <div style="background-color: #fff3cd; padding: 15px; border-radius: 10px; border: 1px solid #ffeeba; margin: 20px 0; font-size: 0.95em; color: #333;">
                <strong>⚠️ Requirements:</strong>
                <ul style="margin-top:10px;">
                    <li>Screen Brightness: <strong>100%</strong></li>
                    <li>Disable "Night Mode" / Blue Light Filters.</li>
                </ul>
            </div>
            
            <p style="font-size: 0.9em; font-style: italic; color: #666;">
                The test runs indefinitely. You can stop whenever you want by simply closing the page.<br>
                (Data is saved automatically every 10 answers).
            </p>

            <button class="btn-primary" onclick="startTest()">Start Experiment</button>
        </div>

        <div class="box" id="interface" style="display:none;">
            <h2 style="margin-bottom: 40px;">Is this Grey?</h2>
            
            <div class="btn-container">
                <button id="btn-yes" onclick="registerResponse('GREY')">YES</button>
                <button id="btn-no" onclick="registerResponse('COLOR')">NO</button>
            </div>
            
            <p style="margin-top: 30px; font-size: 12px; color: #999;">Close tab to finish.</p>
        </div>
    </div>

    <script>
        // *** INCOLLA IL TUO SCRIPT QUI ***
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzc1kIbeH_Yoqur3olqxohcgYH2w4PKTCW8CcwMolUwPNCGzFImJZfC4wtTPI__g8W9jA/exec"; 

        // CONFIGURAZIONE
        const SATURATION_LIMIT = 20; // Range 0% - 20%
        const BATCH_SIZE = 10; // Salva ogni 10 risposte
        
        let currentTrial = {};
        let dataBuffer = []; // Buffer temporaneo per i dati non ancora inviati
        let totalCount = 0;
        let sessionID = Date.now().toString(36) + Math.random().toString(36).substr(2); 

        function getSourceParam() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('source') || 'direct';
        }
        let userSource = getSourceParam();

        function startTest() {
            document.getElementById('welcome').style.display = 'none';
            document.getElementById('interface').style.display = 'block';
            document.getElementById('counter').style.display = 'block';
            nextTrial();
        }

        function nextTrial() {
            // Generazione "Infinite Loop": Creiamo un nuovo colore al volo ogni volta
            
            // 1. Scegliamo tinta (step di 15 gradi per coerenza statistica)
            let hue = (Math.floor(Math.random() * 24)) * 15;
            
            // 2. Scegliamo saturazione (0-50%)
            let sat = Math.floor(Math.random() * (SATURATION_LIMIT + 1));

            currentTrial = { hue: hue, sat: sat };

            // INTER-STIMULUS INTERVAL (NERO)
            document.getElementById('interface').style.opacity = '0';
            document.body.style.backgroundColor = 'black'; 

            setTimeout(() => {
                document.body.style.backgroundColor = `hsl(${hue}, ${sat}%, 50%)`;
                document.getElementById('interface').style.opacity = '1';
            }, 400); 
        }

        function registerResponse(responseType) {
            totalCount++;
            document.getElementById('counter').innerText = `Count: ${totalCount}`;

            // Aggiungiamo al buffer
            dataBuffer.push({
                hue: currentTrial.hue,
                sat: currentTrial.sat,
                response: responseType
            });

            // Se abbiamo raggiunto 10 risposte, inviamo il pacchetto
            if (dataBuffer.length >= BATCH_SIZE) {
                sendDataBatch();
            }

            nextTrial();
        }

        function sendDataBatch() {
            // Copiamo i dati da inviare e svuotiamo il buffer principale
            // Questo evita conflitti se l'utente clicca mentre inviamo
            const dataToSend = [...dataBuffer];
            dataBuffer = []; 
            
            showSaveStatus(true); // Mostra "Saving..."

            if (!GOOGLE_SCRIPT_URL) {
                console.log("Simulazione invio:", dataToSend);
                setTimeout(() => showSaveStatus(false), 1000);
                return;
            }

            const payload = {
                session: sessionID,
                timestamp: new Date().toISOString(),
                source: userSource,
                data: dataToSend
            };

            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                showSaveStatus(false); // Nascondi "Saving..."
            }).catch(err => {
                console.error("Errore salvataggio", err);
            });
        }

        function showSaveStatus(show) {
            const el = document.getElementById('save-status');
            el.style.opacity = show ? '1' : '0';
        }
    </script>
</body>
</html>





